<template>
  <g>
    <Corona v-if="data.corona.length === 8"></Corona>
    <animateTransform
      ref="corona1"
      attributeName="transform"
      type="scale"
      from="0 0"
      calcMode="spline"
      keyTimes="0;.5;1"
      keySplines=".5 0 .5 1; 0 0 1 1"
      to="1 1"
      dur="1s"
      repeatCount="1"
      begin="indefinite"
    />
    <animate
      ref="corona2"
      attributeName="opacity"
      values="0;1"
      dur="0.5s"
      repeatCount="1"
      begin="indefinite"
    />
  </g>
</template>

<script lang="ts" setup>
import { reactive, ref, toRaw } from "@vue/reactivity";
import { onMounted, onBeforeUnmount, h } from "@vue/runtime-core";
import { EnabledPOI, GetPOIs, poi_type } from "../../database/onlineQuery";
import coordtransform from "coordtransform";

const props = withDefaults(
  defineProps<{
    coord: [number, number];
    innerRadius?: number;
  }>(),
  { innerRadius: 60 }
);

const data = reactive({
  categories: {
    科教文化服务: new Array<poi_type>("博物馆", "图书馆"),
    风景名胜: new Array<poi_type>(
      "世界遗产",
      "国家级景点",
      "省级景点",
      "公园广场"
    ),
    交通设施服务: new Array<poi_type>("地铁站", "火车站"),
    生活服务: new Array<poi_type>("中国电信营业厅", "中国移动营业厅"),
    餐饮服务: new Array<poi_type>("快餐厅"),
    购物服务: new Array<poi_type>("超级市场", "购物中心"),
    体育休闲服务: new Array<poi_type>("运动场馆"),
    医疗保健服务: new Array<poi_type>("三级甲等医院"),
  },
  corona: Array<Array<any>>(),
});

const svg_icon = [
  "M315.63 118.583H95.098c-17.6 0-32 14.4-32 32v746.918c0 17.6 14.4 32 32 32H315.63c17.6 0 32-14.4 32-32V150.583c0-17.6-14.4-32-32-32z m-39.133 245.399H134.231c-17.673 0-32-14.327-32-32s14.327-32 32-32h142.266c17.673 0 32 14.327 32 32s-14.327 32-32 32z m0-113.813H134.231c-17.673 0-32-14.327-32-32s14.327-32 32-32h142.266c17.673 0 32 14.327 32 32s-14.327 32-32 32zM571.71 118.583h-149.4c-17.6 0-32 14.4-32 32v746.918c0 17.6 14.4 32 32 32h149.4c17.6 0 32-14.4 32-32V150.583c0-17.6-14.4-32-32-32z m-10.68 245.399H432.99c-17.673 0-32-14.327-32-32s14.327-32 32-32h128.04c17.673 0 32 14.327 32 32s-14.327 32-32 32z m0-113.813H432.99c-17.673 0-32-14.327-32-32s14.327-32 32-32h128.04c17.673 0 32 14.327 32 32s-14.327 32-32 32zM955.119 872.454L819.663 152.356c-3.254-17.297-20.068-28.786-37.364-25.533l-135.388 25.468c-17.297 3.254-28.786 20.067-25.533 37.364l135.456 720.098c3.254 17.297 20.068 28.786 37.364 25.533l135.388-25.468c17.297-3.254 28.787-20.067 25.533-37.364z m-308.92-627.011a32.044 32.044 0 0 1-1.002-7.949c0.005-14.272 9.629-27.279 24.094-30.971l102.455-26.15c17.122-4.372 34.548 5.967 38.92 23.092a32.044 32.044 0 0 1 1.002 7.949c-0.005 14.272-9.629 27.279-24.094 30.971l-102.455 26.15a32.046 32.046 0 0 1-7.938 1.002c-14.276 0-27.288-9.624-30.982-24.094z m169.523 107.219l-102.455 26.151a32.046 32.046 0 0 1-7.938 1.002c-14.276 0-27.289-9.625-30.982-24.094a32.044 32.044 0 0 1-1.002-7.949c0.005-14.272 9.629-27.279 24.094-30.971l102.455-26.151c17.122-4.372 34.548 5.967 38.92 23.092a32.044 32.044 0 0 1 1.002 7.949c-0.005 14.272-9.629 27.279-24.094 30.971z", //library,
  "M192 384a160 160 0 1 0-160-160 160 160 0 0 0 160 160z m246.72 277.76a48 48 0 0 1-87.68-38.4c8.64-21.44 17.6-41.28 26.24-60.8C187.52 344.64 32 960 32 960h960c-140.16-583.04-333.44-848-553.28-298.24z", //scenery
  "M704 64H320c-70.4 0-128 57.6-128 128v464c0 70.4 57.6 128 128 128h384c70.4 0 128-57.6 128-128V192c0-70.4-57.6-128-128-128zM400 112h224c8.8 0 16 7.2 16 16s-7.2 16-16 16H400c-8.8 0-16-7.2-16-16s7.2-16 16-16z m-64 608c-31 0-56-25-56-56s25-56 56-56 56 25 56 56-25 56-56 56z m352 0c-31 0-56-25-56-56s25-56 56-56 56 25 56 56-25 56-56 56z m80-304c0 17.6-14.4 32-32 32H288.4c-17.6 0-32.4-14.4-32.4-32v-191.6c0-17.6 14.8-32.4 32.4-32.4H736c17.6 0 32 14.8 32 32.4V416z m19.4 495.8l-100-96c-11.2-10.8-28.8-10.4-39.6 0.8-10.8 11.2-10.4 28.8 0.8 39.6l12.2 11.8H363l12.2-11.8c11.2-10.8 11.6-28.4 0.8-39.6-10.8-11.2-28.4-11.6-39.6-0.8l-100 96c-11.2 10.8-11.6 28.4-0.8 39.6 5.4 5.8 12.8 8.6 20.2 8.6 7 0 14-2.6 19.4-7.8l29.4-28.2h414.4l29.4 28.2c5.4 5.2 12.4 7.8 19.4 7.8 7.4 0 14.8-2.8 20.2-8.6 11-11.2 10.6-28.8-0.6-39.6z", //subway
  "M853.333333 170.666667H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333333v512c0 46.933333 38.4 85.333333 85.333334 85.333333h682.666666c46.933333 0 85.333333-38.4 85.333334-85.333333V256c0-46.933333-38.4-85.333333-85.333334-85.333333z m-17.066666 181.333333l-279.04 174.506667c-27.733333 17.493333-62.72 17.493333-90.453334 0L187.733333 352a36.266667 36.266667 0 1 1 38.4-61.44L512 469.333333l285.866667-178.773333a36.266667 36.266667 0 1 1 38.4 61.44z", // life
  "M209.454545 0l-46.545454 325.818182c-6.516364 46.08 115.432727 130.327273 116.363636 186.181818V1024h93.090909V512c0-55.854545 122.88-140.101818 116.363637-186.181818L442.181818 0h-46.545454l23.272727 256-69.818182 46.545455V0h-46.545454v302.545455l-69.818182-46.545455L256 0h-46.545455zM837.818182 0C698.181818 0 652.194909 160.488727 651.636364 279.272727v279.272728h93.090909v465.454545h93.090909V0z", //restaurant
  "M376.411417 748.84729c-52.905954 0-95.79988 41.172725-95.79988 91.966575 0 50.794873 42.893926 91.967598 95.79988 91.967598 52.925397 0 95.819322-41.172725 95.819322-91.967598C472.23074 790.021038 429.337837 748.84729 376.411417 748.84729zM874.613156 583.307046l114.963335-294.28956c2.958378-57.405431-38.308491-55.17667-38.308491-55.17667L280.612561 233.840816c18.264992-84.441181-57.491389-128.749316-57.491389-128.749316L88.993359 105.0915c-76.318176 20.712741-19.163455 91.967598-19.163455 91.967598l114.982778 18.394952c0 0 59.493999 347.561857 76.636425 423.038876 17.142425 75.478042 38.327934 73.571622 38.327934 73.571622L874.613156 712.064548c40.61093-62.812581 0-73.571622 0-73.571622L357.267405 638.492926l0-55.18588L874.613156 583.307046zM759.649821 748.84729c-52.924373 0-95.798856 41.172725-95.798856 91.966575 0 50.794873 42.874483 91.967598 95.798856 91.967598 52.925397 0 95.79988-41.172725 95.79988-91.967598C855.449701 790.021038 812.574195 748.84729 759.649821 748.84729z", //shop
  "M150.959487 390.900631q-11.250554 13.29611-20.455553 31.706107-8.182221 15.341665-14.318887 36.819996t-6.136666 49.093327q0 32.728885 5.625277 57.275549t12.784721 40.911106q8.182221 18.409998 19.432775 32.728885 17.38722-11.250554 31.706107-29.660552 11.250554-15.341665 21.478331-39.37694t10.227777-59.832493q0-26.592219-9.716388-49.093327t-20.966942-37.842773q-13.29611-18.409998-29.660552-32.728885zM182.665595 354.080635q19.432775 20.455553 34.77444 46.024995 13.29611 21.478331 24.035275 49.604716t10.739165 59.832493q0 42.956662-12.273332 73.128602t-26.592219 50.627494q-17.38722 23.523886-37.842773 37.842773 22.501108 17.38722 48.07055 29.660552 21.478331 11.250554 48.581939 20.455553t55.741382 9.204999q30.68333 0 57.275549-7.670832t47.047772-17.898609q23.523886-11.250554 41.933884-26.592219-20.455553-15.341665-37.842773-39.888329-14.318887-20.455553-26.592219-52.16166t-12.273332-77.731102q-1.022778-32.728885 11.250554-59.832493t26.592219-47.559161q17.38722-23.523886 38.865551-41.933884-18.409998-16.364442-41.933884-28.637774-20.455553-11.250554-47.047772-19.944164t-57.275549-8.69361q-29.660552 0-55.229993 8.182221t-46.024995 18.409998q-23.523886 11.250554-43.979439 25.569441zM499.726668 391.923409q10.227777 12.273332 19.432775 30.68333 8.182221 15.341665 14.318887 37.331384t6.136666 49.604716q0 32.728885-6.136666 57.275549t-13.29611 40.911106q-8.182221 19.432775-18.409998 32.728885-18.409998-11.250554-31.706107-29.660552-11.250554-15.341665-21.478331-39.37694t-9.204999-59.832493q0-26.592219 9.204999-49.093327t20.455553-37.842773q13.29611-18.409998 30.68333-32.728885zM694.054423 559.658944q-8.182221-58.298326-15.853054-100.743599t-8.69361-78.242491q-1.022778-17.38722-2.045555-59.832493t-2.556944-90.004434-2.556944-91.027211-1.022778-62.900826q1.022778-40.911106 24.035275-59.832493t61.878048-16.875831q35.797218 1.022778 59.832493 17.38722t24.035275 53.184438l0 73.639991q0 41.933884-0.511389 84.379157t-1.022778 80.799435-1.534166 61.878048-3.579722 43.979439-6.136666 42.445273-8.182221 46.536383-8.69361 55.229993l-107.391654 0zM701.213866 608.752272l20.455553 251.603303q-12.273332 3.068333-23.523886 7.159444-9.204999 4.091111-18.921387 9.716388t-14.830276 14.830276-2.045555 20.966942 13.807498 22.501108 29.149163 18.409998 45.002217 7.670832 46.536383-7.670832 31.194719-18.921387 13.807498-24.035275-4.602499-21.98972q-8.182221-9.204999-17.898609-15.341665t-18.921387-9.204999q-11.250554-4.091111-21.478331-5.113888l18.409998-250.580526-96.1411 0z", //sports
  "M939.2896 400.2816a157.952 157.952 0 0 1 0 223.4624L623.744 939.3152a158.08 158.08 0 0 1-223.488 0L84.7104 623.744a157.952 157.952 0 0 1 0-223.4624L400.256 84.736a158.0032 158.0032 0 0 1 223.488 0l315.5456 315.5712zM771.4816 601.6v-165.1968h-174.592v-174.5664h-165.1712v174.592h-174.5408v165.1712h174.5408v174.5408h165.1968v-174.5408h174.5664z",
];

let request_controller = new AbortController();

const corona1 = ref();
const corona2 = ref();
async function GenCorona(coord: [number, number]) {
  for (const key in data.categories) {
    if (Object.prototype.hasOwnProperty.call(data.categories, key)) {
      const pois = data.categories[key];
      let res = await GetPOIs(coord, request_controller, 1, EnabledPOI(pois));
      data.corona.push(res.pois);
    }

    request_controller = new AbortController();
  }
  corona1.value.beginElement();
  corona2.value.beginElement();
}

function GetXY(rotate: number, offset: number) {
  let deg = (Math.PI * rotate) / 180;
  return [Math.cos(deg) * offset, Math.sin(deg) * offset];
}

function GetPoints(index: number) {
  let angle = (index - 4) * 45;
  let XY0 = GetXY(angle, props.innerRadius);
  let XY1 = GetXY(angle, props.innerRadius + 14);
  //   let XY2 = GetXY(angle, props.innerRadius + 25);

  let icon_offset = props.innerRadius + 35;
  let ans = [];
  if (!data.corona[index]) {
    return ans;
  }
  let inner1 = data.corona[index].filter(
    (d) => Number.parseInt(d.distance as string) < 5000
  );
  let inner2 = data.corona[index].filter(
    (d) => Number.parseInt(d.distance as string) < 1000
  );

  if (inner1.length > 0) {
    ans.push(
      h("circle", {
        fill: "rgba(128,128,128,0.5)",
        cx: XY0[0],
        cy: XY0[1],
        r: 5,
      })
    );
  } else {
    icon_offset = props.innerRadius + 5;
  }

  if (inner2.length > 0) {
    ans.push(
      h("circle", {
        fill: "rgba(128,128,128,0.5)",
        cx: XY1[0],
        cy: XY1[1],
        r: 4,
      })
    );
  } else {
    icon_offset = props.innerRadius + 20;
  }

  let XY_icon = GetXY(angle, icon_offset);
  ans.push(
    h(
      "g",
      {
        transform: `translate(${XY_icon[0] - 10},${XY_icon[1] - 10})`,
      },
      h(
        "g",
        { transform: "scale(0.02,0.02)" },
        h("path", {
          d: svg_icon[index],
          fill: "rgba(128,128,128,0.5)",
          style: "height:3;width:3",
        })
      )
    )
  );
  return ans;
}

function Corona() {
  return Array.from({ length: 8 }).map((d, i) => {
    return h("g", { key: "corona" + i }, GetPoints(i));
  });
}

onMounted(() => {
  GenCorona(coordtransform.wgs84togcj02(props.coord[0], props.coord[1]));
});

onBeforeUnmount(() => {
  request_controller.abort();
});
</script>
